(function(t){var e={};function n(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(r,s,function(e){return t[e]}.bind(null,s));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="https://cdn.jsdelivr.net/gh/arkntools/arknights-toolbox@gh-pages/",n(n.s="48d1")})({"48d1":function(t,e,n){"use strict";n.r(e),n.d(e,"DeportRecognizer",(function(){return pt}));const r=Symbol("Comlink.proxy"),s=Symbol("Comlink.endpoint"),i=Symbol("Comlink.releaseProxy"),o=Symbol("Comlink.thrown"),a=t=>"object"===typeof t&&null!==t||"function"===typeof t,l={canHandle:t=>a(t)&&t[r],serialize(t){const{port1:e,port2:n}=new MessageChannel;return p(t,e),[n,[n]]},deserialize(t){return t.start(),d(t)}},c={canHandle:t=>a(t)&&o in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}},u=new Map([["proxy",l],["throw",c]]);function p(t,e=self){e.addEventListener("message",(function n(r){if(!r||!r.data)return;const{id:s,type:i,path:a}=Object.assign({path:[]},r.data),l=(r.data.argumentList||[]).map(j);let c;try{const e=a.slice(0,-1).reduce((t,e)=>t[e],t),n=a.reduce((t,e)=>t[e],t);switch(i){case 0:c=n;break;case 1:e[a.slice(-1)[0]]=j(r.data.value),c=!0;break;case 2:c=n.apply(e,l);break;case 3:{const t=new n(...l);c=M(t)}break;case 4:{const{port1:e,port2:n}=new MessageChannel;p(t,n),c=w(e,[e])}break;case 5:c=void 0;break}}catch(u){c={value:u,[o]:0}}Promise.resolve(c).catch(t=>({value:t,[o]:0})).then(t=>{const[r,o]=x(t);e.postMessage(Object.assign(Object.assign({},r),{id:s}),o),5===i&&(e.removeEventListener("message",n),m(e))})})),e.start&&e.start()}function h(t){return"MessagePort"===t.constructor.name}function m(t){h(t)&&t.close()}function d(t,e){return f(t,[],e)}function g(t){if(t)throw new Error("Proxy has been released and is not useable")}function f(t,e=[],n=function(){}){let r=!1;const o=new Proxy(n,{get(n,s){if(g(r),s===i)return()=>E(t,{type:5,path:e.map(t=>t.toString())}).then(()=>{m(t),r=!0});if("then"===s){if(0===e.length)return{then:()=>o};const n=E(t,{type:0,path:e.map(t=>t.toString())}).then(j);return n.then.bind(n)}return f(t,[...e,s])},set(n,s,i){g(r);const[o,a]=x(i);return E(t,{type:1,path:[...e,s].map(t=>t.toString()),value:o},a).then(j)},apply(n,i,o){g(r);const a=e[e.length-1];if(a===s)return E(t,{type:4}).then(j);if("bind"===a)return f(t,e.slice(0,-1));const[l,c]=v(o);return E(t,{type:2,path:e.map(t=>t.toString()),argumentList:l},c).then(j)},construct(n,s){g(r);const[i,o]=v(s);return E(t,{type:3,path:e.map(t=>t.toString()),argumentList:i},o).then(j)}});return o}function y(t){return Array.prototype.concat.apply([],t)}function v(t){const e=t.map(x);return[e.map(t=>t[0]),y(e.map(t=>t[1]))]}const b=new WeakMap;function w(t,e){return b.set(t,e),t}function M(t){return Object.assign(t,{[r]:!0})}function x(t){for(const[e,n]of u)if(n.canHandle(t)){const[r,s]=n.serialize(t);return[{type:3,name:e,value:r},s]}return[{type:0,value:t},b.get(t)||[]]}function j(t){switch(t.type){case 3:return u.get(t.name).deserialize(t.value);case 0:return t.value}}function E(t,e,n){return new Promise(r=>{const s=P();t.addEventListener("message",(function e(n){n.data&&n.data.id&&n.data.id===s&&(t.removeEventListener("message",e),r(n.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:s},e),n)})}function P(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}self.importScripts("https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js","https://cdn.jsdelivr.net/npm/simple-statistics@7.7.0/dist/simple-statistics.min.js","https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js","https://cdn.jsdelivr.net/npm/@arkntools/scripts@1.0.2/dist/ocrad.js","https://cdn.jsdelivr.net/npm/@arkntools/scripts@1.0.2/dist/jimp.js");const I=({start:t,length:e})=>t+e,S=(t,{start:e,length:n})=>e<=t&&t<e+n,A=(t,e)=>_.findIndex(e,e=>S(t,e)),k=t=>_.transform(t,(t,e,n)=>{if(t.length){if(e){const e=_.last(t);n===I(e)?e.length++:t.push({start:n,length:1})}}else e&&t.push({start:n,length:1})},[]),R=(t,e)=>{const n=_.sortBy(k(t),"length").reverse();if(e){const t=.9*e,r=1.1*e;return _.sortBy(n.filter(({length:e})=>t<e&&e<r),"start")}const r=.8*n[0].length;return _.sortBy(n.filter(({length:t})=>t>r),"start")},O=(t,e=1)=>_.remove(t,({length:t})=>t<=e),z=960,C=540,J=1.15,L=60,W=.28,B=[[1,1,1],[1,-9,1],[1,1,1]],T=(t,e=!1)=>{const n=t.clone(),r=(()=>{const t=n.getWidth(),e=n.getHeight();if(t>=e&&t>z)n.resize(z,Jimp.AUTO);else{if(!(e>t&&e>C))return 1;n.resize(Jimp.AUTO,C)}return t/n.getWidth()})(),s=n.clone().greyscale().convolution(B),i=s.getWidth(),o=s.getHeight(),a=new Array(o).fill(0),l=Math.round(.15*i);s.scan(l,0,i-l,o,(function(t,e,n){a[e]+=this.bitmap.data[n]}));const c=R(a.map(t=>t/255>.005*i));let u=_.min(_.map(c,"length"));const p=c.map(()=>new Array(i).fill(0));s.scan(0,0,i,o,(function(t,e,n){const r=A(e,c);-1!==r&&(p[r][t]+=this.bitmap.data[n])}));const h=p.map(t=>R(t.map(t=>t/255>0),u)),m=_.map(_.flatten(h).filter(({start:t,length:e})=>0!==t&&t+e!==i&&e<u&&1-e/u<.05),"length");m.length&&(u=_.min(m)),c.forEach(t=>{const e=t.start+t.length;t.start=e-u,t.length=u});const d=_.dropRight(c).map(({start:t,length:e},n)=>{const r=t+e,s=c[n+1].start;return s-r}),g=ss.median(d),f=Math.round(g);d.forEach((t,e)=>{if(Math.abs(t-g)/g<.03)return;const n=c[e],r=c[e+1];if(e+1===d.length)return r.start=n.start+n.length+f,void(d[e]=f);const s=c[e+2];r.start=Math.round((n.start+s.start)/2),d[e]=r.start-(n.start+n.length),d[e+1]=s.start-(r.start+r.length)});const y=u*(1+W),v=_.flatten(h).map(({start:t,length:e})=>t+e/2),b=_.min(v),w=Math.ceil(b/y),M=v.map(t=>[w+Math.round((t-b)/y),t]),x=c.map(({start:t,length:e},n)=>{const r=t+e/2;return[n,r]}),j=ss.linearRegressionLine(ss.linearRegression(M)),E=ss.linearRegressionLine(ss.linearRegression(x)),P=Math.round(u*r),I=Math.floor((i+u*(1+W))/y),S=c.length,k=_.range(I).map(t=>{const e=j(t),n=Math.round((e-u/2)*r),s=(e-u*J/2)/i,o=1-(e+u*J/2)/i;return{pos:{x:n},view:{left:s,right:o}}}).filter(({pos:{x:e}})=>e>=0&&e+P<=t.getWidth()),O=_.range(S).map(t=>{const e=E(t),n=Math.round((e-u/2)*r),s=(e-u*J/2)/o,i=1-(e+u*J/2)/o;return{pos:{y:n,l:P},view:{top:s,bottom:i}}}),T=_.flatMap(_.uniqBy(_.flatten(k),"pos.x"),t=>_.uniqBy(_.flatten(O),"pos.y").map(e=>_.merge({debug:{scale:L/(r*u)}},t,e))),D=[];if(e){const e=t.clone();T.forEach(({pos:{x:t,y:n}})=>{for(let r=t;r<t+P;r++)e.setPixelColor(4278190335,r,n),e.setPixelColor(4278190335,r,n+P-1);for(let r=n;r<n+P;r++)e.setPixelColor(4278190335,t,r),e.setPixelColor(4278190335,t+P-1,r)}),D.push(e);const n=s.clone();c.forEach(({start:t,length:e})=>{for(let r=0;r<i;r++)for(let s=t;s<t+e;s++){const t=n.getPixelIndex(r,s);n.bitmap.data[t]=200}}),D.push(n);const r=s.clone();h.forEach((t,e)=>{const n=c[e];t.forEach(({start:t,length:e})=>{for(let s=t;s<t+e;s++)for(let t=n.start;t<n.start+n.length;t++){const e=r.getPixelIndex(s,t);r.bitmap.data[e]=200}})}),D.push(r)}return{debugImgs:D,posisions:T,itemWidth:Math.round(u*r)}},D=t=>t.getBase64Async(Jimp.MIME_PNG),H=60,G=8,U=20,Z=10,F=50,N=22,q=40,X=73,$=(t=>(e=>new Array(t).fill(e))(new Array(t).fill(1/(t*t))))(3),K=(t,e)=>{const n=t.getWidth(),r=[];for(let s=0;s<n;s++)r.push(e(t,s));return k(r)},Q=(t,e)=>{const n=t.getHeight();for(let r=0;r<n;r++){const{r:n}=Jimp.intToRGBA(t.getPixelColor(e,r));if(n<128)return!0}return!1},V=({splitedImgs:t,itemWidth:e,simResults:n,IMG_SL:r})=>{const s=e/r,i=Math.round(q*s),o=Math.round(X*s),a=Math.round(F*s),l=Math.round(N*s);return t.map((t,e)=>{var r,s,c;if(!n[e])return null;const u=t.clone().crop(i,o,a,l).resize(Jimp.AUTO,H,Jimp.RESIZE_BEZIER).invert().threshold({max:104}),p=K(u,Q);O(p,G),0===(null===(r=p[0])||void 0===r?void 0:r.start)&&p.splice(0,1),_.remove(p,({start:t,length:e},n)=>{const r=p[n+1];if(r&&r.start-(t+e)>U)return!0;for(let s=t;s<t+e;s++){const{r:t}=Jimp.intToRGBA(u.getPixelColor(s,0)),{r:e}=Jimp.intToRGBA(u.getPixelColor(s,H-1));if(t<128||e<128)return!0}return!1});const h=Math.max(Math.floor(null!==(c=null===(s=p[0])||void 0===s?void 0:s.start)&&void 0!==c?c:0),0),m=_.last(p),d=Math.min(Math.ceil(m?I(m):u.getWidth()),u.getWidth());(h>0||d<u.getWidth())&&u.crop(h,0,d-h,u.getHeight());const g=new Jimp(u.getWidth()+2*Z,u.getHeight(),"white");return g.composite(u,Z,0).convolution($).invert().threshold({max:2}).invert(),g})},Y=t=>Promise.all(t.map(async t=>{if(!t)return null;const e=new ImageData(new Uint8ClampedArray(t.bitmap.data),t.bitmap.width,t.bitmap.height),n=OCRAD(e,{numeric:!0}).trim(),r=parseInt(n.replace(/[^0-9]/g,""))||1;return{img:await D(t),text:n,value:r,warn:n.replace(/ /g,"")!==String(r)}})),tt={DEFAULT:.2,30021:.15,30041:.12,30042:.12,30043:.12,30044:.12,30062:.15,31024:.22},et=t=>{var e;if(!t)return!1;const{diff:n,name:r}=t,s=null!==(e=tt[r])&&void 0!==e?e:tt.DEFAULT;return n<s},nt=(t,e)=>{if(!e.length)return null;const n=_.sortBy(e.map(([e,n])=>[e,Jimp.diff(t,n,.2).percent]),1),[r,s]=n[0];return{name:r,diff:s,diffs:n}},rt=(t,e)=>{if(t.length<=2)return t.map(t=>nt(t,e));const n=Math.floor(t.length/2),r=nt(t[n],e);if(et(r)){const s=e.findIndex(([t])=>t===r.name);return[...rt(t.slice(0,n),e.slice(0,s)),r,...rt(t.slice(n+1),e.slice(s+1))]}{const s=rt(t.slice(0,n),e),i=_.findLast(s,t=>t),o=rt(t.slice(n+1),et(i)?e.slice(e.findIndex(([t])=>t===i.name)+1):e);return[...s,r,...o]}},st=100,it=183,ot=151,at=(it-ot)/2,lt=new Jimp(54,28,"white"),ct=39,ut=70;class pt{constructor(t){this.config=t,this.isDebug=!1}setDebug(t){this.isDebug=t}async loadResource(){if(this.itemImgs)return this.itemImgs;const t=await JSZip.loadAsync(..._.castArray(this.config.pkg)),e=await Promise.all(this.config.order.map(async e=>{try{const n=t.file(e+".png");return n?await Jimp.read(await n.async("arraybuffer")):void console.warn(`[depot-recognition] ${e}.png not exist in pkg`)}catch(n){console.error("[depot-recognition]",n)}}));return this.itemImgs=_.zip(this.config.order,e.map(t=>null===t||void 0===t?void 0:t.crop(at,at,ot,ot).resize(st,st,Jimp.RESIZE_BEZIER).composite(lt,ct,ut).circle())).filter(([,t])=>t),this.itemImgs}async recognize(t,e=(()=>{})){const n=[],r=(()=>{let t=0;return()=>e(t++)})();r();const[s,i]=await Promise.all([Jimp.read(t),this.loadResource()]);r();const{posisions:o,itemWidth:a,debugImgs:l}=T(s,this.isDebug);this.isDebug&&n.push(...l);const c=o.map(({pos:{x:t,y:e}})=>s.clone().crop(t,e,a,a)),u=c.map(t=>t.clone().resize(st,st).composite(lt,ct,ut).circle());r();const p=rt(u,i);r();const h=V({splitedImgs:c,itemWidth:a,simResults:p,IMG_SL:st});r();const m=await Y(h);return{data:_.merge(o,p.map(t=>({sim:t})),m.map(t=>({num:t}))),debug:await Promise.all(n.map(D))}}}p(Object.keys(e).reduce((function(t,n){return"__esModule"==n||(t[n]=e[n]),t}),{}))}});